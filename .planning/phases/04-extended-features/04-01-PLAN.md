---
phase: 04-extended-features
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/annotate/walker.go
  - internal/annotate/annotate.go
  - internal/annotate/annotate_test.go
  - internal/output/color_test.go
  - cmd/kubectl-fields/main.go
  - testdata/1_deployment_inline_operation.out
  - testdata/1_deployment_above_operation.out
autonomous: true

must_haves:
  truths:
    - "`--show-operation` flag appends lowercase operation type after timestamp in parentheses: `manager (5d ago, apply)`"
    - "Without `--show-operation`, output is byte-identical to current behavior (all existing tests pass unchanged)"
    - "With `--mtime hide --show-operation`, format is `manager (apply)` with parentheses"
    - "With `--mtime absolute --show-operation`, format is `manager (2026-02-07T12:00:00Z, apply)`"
    - "Operation type works identically in both inline and `--above` modes"
  artifacts:
    - path: "internal/annotate/walker.go"
      provides: "AnnotationInfo with Operation field, annotationFrom copies Operation"
      contains: "Operation"
    - path: "internal/annotate/annotate.go"
      provides: "Options.ShowOperation bool, formatComment with showOperation parameter"
      contains: "ShowOperation"
    - path: "cmd/kubectl-fields/main.go"
      provides: "--show-operation CLI flag wired to Options.ShowOperation"
      contains: "show-operation"
    - path: "testdata/1_deployment_inline_operation.out"
      provides: "Golden file for inline mode with --show-operation"
    - path: "testdata/1_deployment_above_operation.out"
      provides: "Golden file for above mode with --show-operation"
  key_links:
    - from: "cmd/kubectl-fields/main.go"
      to: "annotate.Options.ShowOperation"
      via: "cobra Bool flag -> Options struct"
      pattern: "ShowOperation.*showOperation"
    - from: "internal/annotate/annotate.go"
      to: "internal/annotate/walker.go"
      via: "AnnotationInfo.Operation populated from ManagedFieldsEntry.Operation"
      pattern: "Operation.*entry\\.Operation"
---

<objective>
Add `--show-operation` boolean flag that optionally includes the Kubernetes operation type (apply, update) in field ownership annotations.

Purpose: Power users debugging field ownership can see whether a field was set via `apply` or `update`, giving immediate visibility into how each field was last modified.
Output: Extended `formatComment` with operation support, new CLI flag, golden files for operation mode, unit tests for all format combinations.
</objective>

<execution_context>
@/Users/abalkan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abalkan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-extended-features/04-CONTEXT.md
@.planning/phases/04-extended-features/04-RESEARCH.md
@internal/annotate/walker.go
@internal/annotate/annotate.go
@internal/annotate/annotate_test.go
@internal/output/color_test.go
@cmd/kubectl-fields/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Operation to AnnotationInfo, extend formatComment, and write tests (RED then GREEN)</name>
  <files>
    internal/annotate/walker.go
    internal/annotate/annotate.go
    internal/annotate/annotate_test.go
    internal/output/color_test.go
  </files>
  <action>
**Step 1 (RED): Write tests first for all showOperation x MtimeMode combinations.**

In `annotate_test.go`, add these test functions:

1. `TestFormatComment_ShowOperation_Relative` -- `showOperation=true, MtimeRelative`
   - Input: `AnnotationInfo{Manager: "kubectl-apply", Operation: "Update", Time: testNow.Add(-50*time.Minute)}`
   - Expected: `"kubectl-apply (50m ago, update)"` (lowercase!)

2. `TestFormatComment_ShowOperation_Absolute` -- `showOperation=true, MtimeAbsolute`
   - Input: `AnnotationInfo{Manager: "kubectl-apply", Operation: "Apply", Time: time.Date(2026, 2, 7, 12, 0, 0, 0, time.UTC)}`
   - Expected: `"kubectl-apply (2026-02-07T12:00:00Z, apply)"`

3. `TestFormatComment_ShowOperation_Hide` -- `showOperation=true, MtimeHide`
   - Input: `AnnotationInfo{Manager: "kubectl-apply", Operation: "Update", Time: testNow}`
   - Expected: `"kubectl-apply (update)"`

4. `TestFormatComment_ShowOperation_WithSubresource` -- `showOperation=true, MtimeRelative, Subresource: "status"`
   - Input: `AnnotationInfo{Manager: "kube-controller-manager", Operation: "Update", Subresource: "status", Time: testNow.Add(-1*time.Hour)}`
   - Expected: `"kube-controller-manager /status (1h ago, update)"`

5. `TestFormatComment_ShowOperation_EmptyOperation` -- `showOperation=true` but `Operation: ""`
   - Should produce same output as `showOperation=false` (graceful fallback)
   - Expected: `"kubectl-apply (50m ago)"`

6. `TestFormatComment_ShowOperation_False` -- `showOperation=false, Operation: "Update"`
   - Must produce byte-identical output to existing behavior
   - Expected: `"kubectl-apply (50m ago)"`

**IMPORTANT:** The new `formatComment` signature will be `formatComment(info AnnotationInfo, now time.Time, mtime MtimeMode, showOperation bool)`. The tests call this new signature. Existing `formatComment` tests must be updated to pass `false` as the fourth argument so they continue to pass unchanged in behavior.

In `color_test.go`, add three test cases to the existing `TestExtractManagerName` table:
- `{name: "with operation and age", comment: "# manager (5d ago, apply)", expected: "manager"}`
- `{name: "with subresource and operation", comment: "# manager /status (1h ago, update)", expected: "manager"}`
- `{name: "operation only (hide mode)", comment: "# manager (apply)", expected: "manager"}`

Run `go test ./internal/annotate/ ./internal/output/` -- tests should FAIL (RED) because formatComment doesn't have the showOperation parameter yet.

**Step 2 (GREEN): Implement the changes.**

In `walker.go`:
- Add `Operation string` field to `AnnotationInfo` struct (after Manager, before Subresource)
- In `annotationFrom`, add `Operation: entry.Operation,` to the return struct

In `annotate.go`:
- Add `ShowOperation bool` to `Options` struct
- Change `formatComment` signature to: `func formatComment(info AnnotationInfo, now time.Time, mtime MtimeMode, showOperation bool) string`
- Add operation formatting logic inside `formatComment`:
  - Compute `op := ""` then `if showOperation && info.Operation != "" { op = strings.ToLower(info.Operation) }`
  - Add `"strings"` to imports
  - For `MtimeAbsolute`: if `op != ""`, return `fmt.Sprintf("%s (%s, %s)", base, ts, op)`, else existing format
  - For `MtimeHide`: if `op != ""`, return `fmt.Sprintf("%s (%s)", base, op)`, else return `base`
  - For default (relative): if `op != ""`, return `fmt.Sprintf("%s (%s, %s)", base, age, op)`, else existing format
- Update the `Annotate` function call site: change `formatComment(target.Info, opts.Now, mtime)` to `formatComment(target.Info, opts.Now, mtime, opts.ShowOperation)`

Run `go test ./internal/annotate/ ./internal/output/` -- ALL tests should pass (GREEN), including all existing tests which now pass `false` for showOperation.
  </action>
  <verify>
`cd /Users/abalkan/oss/kubectl-fields20 && go test ./internal/annotate/ ./internal/output/` -- all tests pass, zero failures.
  </verify>
  <done>
- All 6 new formatComment test cases pass with correct output
- 3 new extractManagerName test cases pass
- All existing formatComment tests pass unchanged (with `false` fourth arg)
- All existing annotate integration tests pass unchanged
- All existing golden file tests pass unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire --show-operation flag in CLI, add golden files, add integration test</name>
  <files>
    cmd/kubectl-fields/main.go
    internal/annotate/annotate_test.go
    testdata/1_deployment_inline_operation.out
    testdata/1_deployment_above_operation.out
  </files>
  <action>
**Step 1: Wire the CLI flag.**

In `cmd/kubectl-fields/main.go`:
- Add `--show-operation` boolean flag: `rootCmd.Flags().Bool("show-operation", false, "Include operation type (apply, update) in annotations")`
- In `RunE`, read it: `showOperation, _ := cmd.Flags().GetBool("show-operation")`
- Pass to `annotate.Options`: add `ShowOperation: showOperation,` to the Options struct literal
- Update the Long description to add an example: `kubectl get deploy nginx -o yaml --show-managed-fields | kubectl-fields --show-operation`

**Step 2: Add golden file test helpers and tests.**

In `annotate_test.go`:
- Extend `processDeploymentFixture` to accept `showOperation bool` parameter (add it after `above bool`):
  ```go
  func processDeploymentFixture(t *testing.T, above bool, showOperation bool, fixedNow time.Time) string
  ```
  And pass `ShowOperation: showOperation` in the `Options` struct inside that function.
- Update the two existing golden file test calls (`TestAnnotate_GoldenInline`, `TestAnnotate_GoldenAbove`) to pass `false` for the new `showOperation` parameter.

- Add `TestAnnotate_GoldenInlineOperation`:
  - Use same `fixedNow` as `TestAnnotate_GoldenInline`: `time.Date(2024, 4, 10, 1, 34, 50, 0, time.UTC)`
  - Call `processDeploymentFixture(t, false, true, fixedNow)`
  - Golden path: `../../testdata/1_deployment_inline_operation.out`
  - Support `UPDATE_GOLDEN` env var same as existing golden tests

- Add `TestAnnotate_GoldenAboveOperation`:
  - Use same `fixedNow` as `TestAnnotate_GoldenAbove`: `time.Date(2024, 4, 10, 17, 39, 50, 0, time.UTC)`
  - Call `processDeploymentFixture(t, true, true, fixedNow)`
  - Golden path: `../../testdata/1_deployment_above_operation.out`
  - Support `UPDATE_GOLDEN` env var same as existing golden tests

**Step 3: Generate golden files.**

Run with `UPDATE_GOLDEN=1 go test ./internal/annotate/ -run "GoldenInlineOperation|GoldenAboveOperation"` to generate the two new golden files.

**Step 4: Verify golden file content.**

Read the generated golden files and verify:
- They contain `, update)` or `, apply)` after timestamps (the test fixture `1_deployment.yaml` has `operation: Update` for all entries, so expect `update`)
- They are otherwise structurally identical to the non-operation golden files
- The operation string is lowercase

**Step 5: Run full test suite.**

Run `go build ./... && go test ./...` to verify everything passes.
  </action>
  <verify>
`cd /Users/abalkan/oss/kubectl-fields20 && go build ./... && go test ./...` -- builds successfully and all tests pass.
Verify golden files exist: `ls testdata/1_deployment_inline_operation.out testdata/1_deployment_above_operation.out`
Verify golden files contain operation: `grep -c ", update)" testdata/1_deployment_inline_operation.out` should return > 0.
  </verify>
  <done>
- `--show-operation` flag registered in cobra and wired to Options.ShowOperation
- Two new golden files generated and verified
- Existing golden file tests still pass (byte-identical output)
- `go build ./...` succeeds
- `go test ./...` all pass
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- compiles without errors
2. `go test ./...` -- all tests pass (existing + new)
3. `echo "apiVersion: v1" | go run ./cmd/kubectl-fields/ --show-operation` -- runs without error (no managedFields, just warning)
4. Golden file content check: new golden files contain `, update)` pattern
5. Existing golden files unchanged: `git diff testdata/1_deployment_inline.out testdata/1_deployment_above.out` shows no changes
</verification>

<success_criteria>
- `--show-operation` flag produces `manager (time, operation)` format with lowercase operation
- Without `--show-operation`, output is byte-identical to Phase 3 (all existing tests pass)
- All MtimeMode x ShowOperation combinations produce correct format
- Two new golden files exist and pass
- `extractManagerName` handles new format correctly (existing color system unaffected)
</success_criteria>

<output>
After completion, create `.planning/phases/04-extended-features/04-01-SUMMARY.md`
</output>
