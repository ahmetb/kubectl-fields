---
phase: 01-foundation-input-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - Makefile
  - cmd/kubectl-fields/main.go
  - internal/parser/parser.go
  - internal/parser/parser_test.go
  - testdata/roundtrip/deployment.yaml
  - testdata/roundtrip/configmap.yaml
  - testdata/roundtrip/service.yaml
  - testdata/roundtrip/multidoc.yaml
  - testdata/roundtrip/list_kind.yaml
autonomous: true

must_haves:
  truths:
    - "go build ./... compiles a working kubectl-fields binary with cobra CLI"
    - "YAML piped to stdin is decoded into yaml.Node documents and re-encoded to stdout"
    - "Multi-document YAML (--- separated) round-trips correctly with each document preserved"
    - "List kind input (kind: List) unwraps items and emits each as a separate document"
    - "Round-trip fidelity: decode then encode (no modifications) produces byte-identical output to the input for kubectl-style YAML"
  artifacts:
    - path: "go.mod"
      provides: "Module definition with go.yaml.in/yaml/v3 v3.0.4, cobra v1.10.2, testify v1.11.1, gotest.tools/v3 v3.5.2"
      contains: "go.yaml.in/yaml/v3"
    - path: "cmd/kubectl-fields/main.go"
      provides: "CLI entrypoint with cobra root command reading stdin and writing stdout"
      min_lines: 30
    - path: "internal/parser/parser.go"
      provides: "ParseDocuments, UnwrapListKind, EncodeDocuments functions"
      exports: ["ParseDocuments", "UnwrapListKind", "EncodeDocuments"]
    - path: "internal/parser/parser_test.go"
      provides: "Round-trip fidelity tests, multi-doc tests, List kind tests"
      min_lines: 80
    - path: "Makefile"
      provides: "build, test, clean targets"
  key_links:
    - from: "cmd/kubectl-fields/main.go"
      to: "internal/parser/parser.go"
      via: "imports parser package, calls ParseDocuments + EncodeDocuments"
      pattern: "parser\\.ParseDocuments|parser\\.EncodeDocuments"
    - from: "internal/parser/parser.go"
      to: "go.yaml.in/yaml/v3"
      via: "yaml.NewDecoder, yaml.NewEncoder with SetIndent(2) + CompactSeqIndent()"
      pattern: "CompactSeqIndent"
---

<objective>
Set up the Go project with module, CLI scaffold, YAML parsing pipeline, and round-trip fidelity validation.

Purpose: Establish the foundation that all subsequent phases build on. The YAML parser must decode stdin, handle multi-document and List kind input, and re-encode to stdout with perfect round-trip fidelity. If round-trip fidelity fails here, the entire project approach needs rethinking before investing in annotation logic.

Output: A working `kubectl-fields` binary that accepts YAML on stdin and emits it unchanged on stdout, proving the parsing pipeline works. Round-trip fidelity tests pass with real kubectl-style YAML fixtures.
</objective>

<execution_context>
@/Users/abalkan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abalkan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-input-pipeline/01-RESEARCH.md
@testdata/1_deployment.yaml
@testdata/0_no_managedFields.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Go project scaffold with module, CLI, and Makefile</name>
  <files>
    go.mod
    go.sum
    cmd/kubectl-fields/main.go
    Makefile
  </files>
  <action>
Initialize the Go module and install dependencies:
```bash
go mod init github.com/rewanthtammana/kubectl-fields
go get go.yaml.in/yaml/v3@v3.0.4
go get github.com/spf13/cobra@v1.10.2
go get github.com/stretchr/testify@v1.11.1
go get gotest.tools/v3@v3.5.2
```

Create `cmd/kubectl-fields/main.go`:
- Import cobra for CLI framework
- Create a root command with:
  - Use: "kubectl-fields"
  - Short: "Annotate Kubernetes YAML with field ownership information"
  - Long description explaining the stdin pipe workflow
  - RunE function that: reads all of stdin, calls `parser.ParseDocuments(os.Stdin)`, calls `parser.EncodeDocuments(os.Stdout, docs)`, returns any error
- In main(), call `rootCmd.Execute()` and exit(1) on error
- Do NOT add any flags yet (flags come in later plans/phases)
- Do NOT add version subcommand yet

Create `Makefile` with targets:
- `build`: `go build -o bin/kubectl-fields ./cmd/kubectl-fields`
- `test`: `go test ./... -v`
- `clean`: `rm -rf bin/`
- `lint`: `go vet ./...`
- Default target: `build`
- `.PHONY` declarations for all targets
  </action>
  <verify>
Run `go build ./cmd/kubectl-fields` -- must compile with zero errors.
Run `echo "hello: world" | go run ./cmd/kubectl-fields` -- must output `hello: world`.
  </verify>
  <done>
Binary compiles. Piping simple YAML through it produces output. Makefile build and test targets work.
  </done>
</task>

<task type="auto">
  <name>Task 2: YAML document parser with multi-doc, List kind, and round-trip fidelity tests</name>
  <files>
    internal/parser/parser.go
    internal/parser/parser_test.go
    testdata/roundtrip/deployment.yaml
    testdata/roundtrip/configmap.yaml
    testdata/roundtrip/service.yaml
    testdata/roundtrip/multidoc.yaml
    testdata/roundtrip/list_kind.yaml
  </files>
  <action>
Create `internal/parser/parser.go` with three exported functions:

**ParseDocuments(r io.Reader) ([]*yaml.Node, error)**
- Create `yaml.NewDecoder(r)`
- Loop calling `decoder.Decode(&doc)` until `io.EOF`
- Return errors wrapped with `fmt.Errorf("YAML parse error: %w", err)`
- Each decoded doc is a `*yaml.Node` with Kind == DocumentNode

**UnwrapListKind(doc *yaml.Node) []*yaml.Node**
- If doc is not a DocumentNode or has no Content, return `[]*yaml.Node{doc}`
- Get the root MappingNode from doc.Content[0]
- Check if the "kind" key has value "List" (use helper function `getMapValue`)
- If not a List, return `[]*yaml.Node{doc}` unchanged
- If it IS a List, find the "items" key's SequenceNode value
- For each item in the SequenceNode's Content, wrap it in a new DocumentNode
- Return the slice of wrapped item DocumentNodes

**EncodeDocuments(w io.Writer, docs []*yaml.Node) error**
- Create `yaml.NewEncoder(w)`
- Call `enc.SetIndent(2)` -- CRITICAL: matches kubectl's 2-space indent
- Call `enc.CompactSeqIndent()` -- CRITICAL: matches kubectl's compact sequence style
- Loop encoding each doc with `enc.Encode(doc)`
- Call `enc.Close()` at the end (use defer)

Helper functions (unexported):
- `getMapValue(mapping *yaml.Node, key string) (string, bool)` -- iterate Content by 2, find key, return its string Value
- `getMapValueNode(mapping *yaml.Node, key string) (*yaml.Node, bool)` -- same but return the value Node

Create round-trip test fixtures in `testdata/roundtrip/`:

**deployment.yaml** -- Copy the YAML body from `testdata/1_deployment.yaml` but WITHOUT the managedFields section. This tests that the non-managedFields portions round-trip perfectly. Strip lines 14-125 (the entire managedFields block including the key and all entries), keeping everything else intact.

**configmap.yaml** -- Create a realistic ConfigMap with:
- Quoted boolean-like values: `enabled: "yes"`, `debug: "true"`, `count: "null"`
- A literal block scalar annotation (using `|`)
- Flow-style empty map: `data: {}`
This tests YAML 1.1 value preservation (quoting) and style preservation.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-config
  namespace: default
  annotations:
    description: |
      This is a multi-line
      annotation value.
data:
  enabled: "yes"
  debug: "true"
  count: "null"
  simple: plain-value
labels: {}
```

**service.yaml** -- Create a realistic Service with ports list:
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: my-app
  ports:
  - name: http
    port: 80
    targetPort: 8080
    protocol: TCP
  - name: https
    port: 443
    targetPort: 8443
    protocol: TCP
```

**multidoc.yaml** -- Two documents separated by `---`:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-one
data:
  key: value1
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-two
data:
  key: value2
```

**list_kind.yaml** -- A List-wrapped set of resources:
```yaml
apiVersion: v1
kind: List
metadata:
  resourceVersion: ""
items:
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: cm-one
  data:
    key: val1
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: cm-two
  data:
    key: val2
```

Create `internal/parser/parser_test.go` with these tests:

**TestParseDocuments_SingleDoc** -- Parse a simple YAML string, assert 1 document, assert root is MappingNode.

**TestParseDocuments_MultiDoc** -- Parse the multidoc.yaml fixture, assert 2 documents.

**TestParseDocuments_EmptyInput** -- Parse empty string, assert 0 documents, no error.

**TestParseDocuments_InvalidYAML** -- Parse `":\n  - :\n    -"`, assert error returned.

**TestUnwrapListKind_NotAList** -- Pass a non-List document, assert returns same single document.

**TestUnwrapListKind_ListWithItems** -- Parse list_kind.yaml, call UnwrapListKind, assert returns 2 documents, each containing one ConfigMap.

**TestRoundTrip_Deployment** -- Read testdata/roundtrip/deployment.yaml, ParseDocuments, EncodeDocuments to buffer, compare byte-for-byte (trim trailing newline). This is the CRITICAL round-trip fidelity test.

**TestRoundTrip_ConfigMap** -- Same pattern with configmap.yaml. Validates quoted values like `"yes"` survive round-trip.

**TestRoundTrip_Service** -- Same pattern with service.yaml. Validates compact sequence indent for ports list.

**TestRoundTrip_MultiDoc** -- Read multidoc.yaml, parse, encode, compare. Validates `---` separators are preserved between documents.

**TestRoundTrip_ListKind** -- Read list_kind.yaml, parse, UnwrapListKind all docs, encode the unwrapped items, verify output has 2 separate documents (each preceded by `---` except the first).

For all round-trip tests, use `require.NoError` for parsing/encoding and `assert.Equal` for content comparison. Trim trailing newlines from both expected and actual before comparing. If a round-trip test fails due to a known go-yaml formatting difference, add a clear comment explaining the difference and skip the test with `t.Skip("known go-yaml limitation: ...")` so the test suite still passes -- but DO NOT silently accept differences. Each known difference must be explicitly documented.

IMPORTANT: The round-trip deployment test is the #1 validation item for this entire phase. If it fails, investigate WHY before proceeding. Check: is it CompactSeqIndent? Is it quoting? Is it literal block scalars? Document findings.
  </action>
  <verify>
Run `go test ./internal/parser/ -v` -- all tests pass.
Run `cat testdata/roundtrip/deployment.yaml | go run ./cmd/kubectl-fields` and visually verify the output matches the input (no managedFields in fixture, so it should pass through unchanged).
Run `cat testdata/roundtrip/multidoc.yaml | go run ./cmd/kubectl-fields` and verify both documents appear separated by `---`.
  </verify>
  <done>
All parser tests pass including round-trip fidelity. Multi-document and List kind handling works. The YAML pipeline preserves formatting (indentation, quoting, key ordering, compact sequence indent). Any known go-yaml limitations are documented with skipped tests.
  </done>
</task>

</tasks>

<verification>
1. `go build ./cmd/kubectl-fields` compiles without errors
2. `go test ./... -v` passes all tests
3. `go vet ./...` reports no issues
4. Round-trip fidelity: `cat testdata/roundtrip/deployment.yaml | go run ./cmd/kubectl-fields | diff - testdata/roundtrip/deployment.yaml` shows no differences (or only documented, acceptable differences)
5. Multi-doc: `cat testdata/roundtrip/multidoc.yaml | go run ./cmd/kubectl-fields` preserves both documents with `---` separator
6. List kind: `cat testdata/roundtrip/list_kind.yaml | go run ./cmd/kubectl-fields` unwraps and emits 2 separate documents
</verification>

<success_criteria>
- Binary compiles and runs as a stdin-to-stdout YAML pipeline
- All round-trip fidelity tests pass (deployment, configmap, service fixtures)
- Multi-document YAML parsing and encoding works with correct `---` separators
- List kind unwrapping produces individual documents from items array
- No go vet warnings
- Test coverage for: single doc, multi-doc, List kind, empty input, invalid YAML, round-trip preservation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-input-pipeline/01-01-SUMMARY.md`
</output>
