---
phase: 03-output-polish-color
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - cmd/kubectl-fields/main.go
  - go.mod
  - go.sum
  - testdata/1_deployment_inline.out
  - testdata/1_deployment_above.out
  - internal/annotate/annotate_test.go
autonomous: true

must_haves:
  truths:
    - "--color auto|always|never flag controls ANSI output (auto detects TTY)"
    - "--mtime relative|absolute|hide flag controls timestamp display"
    - "Piped output contains no ANSI escape codes (--color auto default behavior)"
    - "Golden files match new comment format (two-unit time, /sub notation)"
    - "End-to-end pipeline: encode -> align -> colorize -> stdout"
  artifacts:
    - path: "cmd/kubectl-fields/main.go"
      provides: "CLI with --color, --mtime flags and post-processing pipeline"
      contains: "FormatOutput"
    - path: "testdata/1_deployment_inline.out"
      provides: "Golden file for inline mode with updated format"
    - path: "testdata/1_deployment_above.out"
      provides: "Golden file for above mode with updated format"
  key_links:
    - from: "cmd/kubectl-fields/main.go"
      to: "internal/output/formatter.go"
      via: "FormatOutput call in CLI pipeline"
      pattern: "output\\.FormatOutput"
    - from: "cmd/kubectl-fields/main.go"
      to: "internal/output/color.go"
      via: "ResolveColor and NewColorManager"
      pattern: "output\\.ResolveColor|output\\.NewColorManager"
    - from: "cmd/kubectl-fields/main.go"
      to: "internal/annotate/annotate.go"
      via: "Options.Mtime from --mtime flag"
      pattern: "Mtime.*MtimeMode|annotate\\.Mtime"
---

<objective>
Wire the output polish libraries into the CLI and validate end-to-end with updated golden files. Adds --color and --mtime flags, integrates the encode->align->colorize pipeline, adds golang.org/x/term dependency for TTY detection, and regenerates golden files to match the new comment format.

Purpose: This plan connects all the library code from Plan 01 to the actual CLI, making the output polish visible to users. Golden file updates ensure the new format is the verified source of truth.
Output: Working CLI with --color and --mtime flags, updated golden files, passing end-to-end tests.
</objective>

<execution_context>
@/Users/abalkan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abalkan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-output-polish-color/03-CONTEXT.md
@.planning/phases/03-output-polish-color/03-RESEARCH.md
@.planning/phases/03-output-polish-color/03-01-SUMMARY.md
@cmd/kubectl-fields/main.go
@internal/output/formatter.go
@internal/output/color.go
@internal/output/align.go
@internal/annotate/annotate.go
@internal/annotate/annotate_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI flags, x/term dependency, and post-processing pipeline</name>
  <files>
    cmd/kubectl-fields/main.go
    go.mod
    go.sum
  </files>
  <action>
**Add golang.org/x/term dependency:**
Run `go get golang.org/x/term@latest` to add TTY detection support.

**Add pflag.Value types** for --color and --mtime flags. These can be defined in main.go or a separate flags file (keep simple -- main.go is fine since there are only two):

```go
type colorFlag string
func (f *colorFlag) String() string { return string(*f) }
func (f *colorFlag) Set(val string) error {
    switch val {
    case "auto", "always", "never":
        *f = colorFlag(val)
        return nil
    default:
        return fmt.Errorf("must be one of: auto, always, never")
    }
}
func (f *colorFlag) Type() string { return "string" }
```

Same pattern for `mtimeFlag` with values "relative", "absolute", "hide".

**Register flags on cobra command:**
- `--color` with default "auto", usage: "Color output: auto, always, never"
- `--mtime` with default "relative", usage: "Timestamp display: relative, absolute, hide"
- Use `cmd.Flags().Var(&colorFlagVar, "color", "...")` for pflag.Value types

**Update the RunE function pipeline:**
1. Parse flags: get --above (existing), --color, --mtime values
2. Resolve color: `colorEnabled := output.ResolveColor(string(colorFlagVar), term.IsTerminal(int(os.Stdout.Fd())))`
3. Create color manager: `colorMgr := output.NewColorManager()` (only needed if colorEnabled, but cheap to create)
4. Process documents as before: parse -> unwrap -> extract managedFields -> annotate -> strip
5. Pass `annotate.Options{Above: aboveMode, Now: time.Now(), Mtime: annotate.MtimeMode(mtimeFlagVar)}` to Annotate
6. Encode to a bytes.Buffer instead of directly to os.Stdout
7. Post-process: `result := output.FormatOutput(buf.String(), colorEnabled, colorMgr)`
8. Write result to os.Stdout

**Import additions:**
- `"bytes"` for buffer
- `"golang.org/x/term"` for TTY detection
- `"github.com/rewanthtammana/kubectl-fields/internal/output"` for FormatOutput, ResolveColor, NewColorManager

**Update command help text** to mention --color and --mtime in usage examples:
```
kubectl get deploy nginx -o yaml --show-managed-fields | kubectl-fields
kubectl get deploy nginx -o yaml --show-managed-fields | kubectl-fields --color always
kubectl get deploy nginx -o yaml --show-managed-fields | kubectl-fields --mtime hide
```
  </action>
  <verify>
Run `go build ./cmd/kubectl-fields/` -- compiles successfully. Run `./kubectl-fields --help` and verify --color and --mtime flags appear with correct descriptions and defaults. Run `echo "" | ./kubectl-fields --color invalid 2>&1` and verify error message about valid values.
  </verify>
  <done>
CLI compiles with --color auto|always|never and --mtime relative|absolute|hide flags. Pipeline encodes to buffer, then runs FormatOutput (align -> colorize) before writing to stdout. TTY detection via golang.org/x/term integrated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Golden file regeneration and end-to-end tests</name>
  <files>
    testdata/1_deployment_inline.out
    testdata/1_deployment_above.out
    internal/annotate/annotate_test.go
  </files>
  <action>
**Regenerate golden files** for the new comment format. The comment format changed in Plan 01:
- Subresource: `manager (/sub) (age)` -> `manager /sub (age)`
- Timestamps: now two-unit (e.g., `5d12h ago` instead of `5d ago` where applicable)
- The test fixture uses `fixedNow` time for deterministic timestamps

Run the golden file tests with `UPDATE_GOLDEN=1 go test ./internal/annotate/... -run TestGolden` (or whatever the golden test function names are -- check annotate_test.go for exact names). This regenerates testdata/1_deployment_inline.out and testdata/1_deployment_above.out.

**Verify golden files** look correct after regeneration:
- Comments should use new format: `# manager /subresource (Xd ago)` not `# manager (/subresource) (Xd ago)`
- Two-unit timestamps where applicable
- Inline mode: comments on same line as values
- Above mode: comments on line above field keys

**Add new golden file test variants** to `internal/annotate/annotate_test.go` if they don't already exist:
- Test with MtimeAbsolute: process the deployment fixture with mtime=absolute, verify comments contain ISO 8601 timestamps (e.g., `2024-01-15T10:00:00Z`)
- Test with MtimeHide: process fixture with mtime=hide, verify comments have no parenthesized timestamps (just `manager` or `manager /sub`)
- These can be non-golden-file tests (just check specific comment strings exist in output), or separate golden files if warranted. Non-golden string checks are simpler and sufficient.

**Add alignment integration test:**
- Take the inline golden file output, run it through output.AlignComments, verify adjacent annotated lines have comments at the same column. This can be a simple test that checks a known block of lines.

**Add a no-ANSI piped output test:**
- Process text through FormatOutput with colorEnabled=false, verify no `\x1b` bytes in output.
- Process text through FormatOutput with colorEnabled=true, verify `\x1b` bytes present in comment portions.

**Run full test suite:**
`go test ./...` -- all tests across all packages must pass.
  </action>
  <verify>
Run `go test ./...` -- all tests pass (including golden file comparisons, mtime mode tests, alignment test, and color/no-color test). Run `go vet ./...` -- clean.
  </verify>
  <done>
Golden files updated to new comment format. End-to-end tests verify mtime absolute and hide modes. Alignment integration test confirms per-block column alignment. Color/no-color tests confirm ANSI presence/absence. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
- `go test ./...` passes across all packages (timeutil, annotate, output, managed, parser)
- `go build ./cmd/kubectl-fields/` compiles successfully
- `./kubectl-fields --help` shows --color and --mtime flags
- `echo "apiVersion: v1" | ./kubectl-fields --color never` produces no ANSI codes
- Golden files reflect new comment format with two-unit time and /sub notation
- `go vet ./...` clean
</verification>

<success_criteria>
- --color auto|always|never flag works (auto detects TTY, always forces color, never disables)
- --mtime relative|absolute|hide flag controls timestamp display in annotations
- Piped output (non-TTY) contains zero ANSI escape codes by default
- Golden files match new two-unit time format and /sub subresource notation
- End-to-end pipeline: YAML encode -> AlignComments -> Colorize -> stdout
- All tests pass across entire project
</success_criteria>

<output>
After completion, create `.planning/phases/03-output-polish-color/03-02-SUMMARY.md`
</output>
